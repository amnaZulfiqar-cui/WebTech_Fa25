<%- include('../partials/header') %>

<div class="text-center py-5 my-5">
  <!-- Success Icon -->
  <div class="mb-4">
    <div class="success-icon">
      <i class="bi bi-check-circle-fill"></i>
    </div>
  </div>

  <!-- Success Message -->
  <h1 class="display-5 fw-bold text-success mb-3">Order Confirmed!</h1>
  <p class="lead mb-4">
    Thank you for your order. Your order has been successfully placed.
  </p>

  <!-- Order Details -->
  <div class="card mx-auto shadow-sm" style="max-width: 500px">
    <div class="card-body">
      <h5 class="card-title mb-4">
        <i class="bi bi-receipt me-2"></i>
        Order Details
      </h5>

      <div class="text-start">
        <div class="row mb-2">
          <div class="col-6 text-muted">Order ID:</div>
          <div class="col-6 fw-bold"><%= order.orderId %></div>
        </div>

        <div class="row mb-2">
          <div class="col-6 text-muted">Date:</div>
          <div class="col-6">
            <%= new Date(order.createdAt).toLocaleDateString('en-US', { year:
            'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:
            '2-digit' }) %>
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-6 text-muted">Email:</div>
          <div class="col-6"><%= order.customerEmail %></div>
        </div>

        <div class="row mb-2">
          <div class="col-6 text-muted">Total Items:</div>
          <div class="col-6">
            <%= order.items.reduce((sum, item) => sum + item.quantity, 0) %>
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-6 text-muted">Total Amount:</div>
          <div class="col-6 fw-bold text-primary">
            $<%= order.total.toFixed(2) %>
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-6 text-muted">Status:</div>
          <div class="col-6">
            <span class="badge bg-success"><%= order.status %></span>
          </div>
        </div>

        <% if (order.discountCode) { %>
        <div class="row mb-2">
          <div class="col-6 text-muted">Discount Applied:</div>
          <div class="col-6 text-success">
            <%= order.discountCode %> (-$<%= order.discount.toFixed(2) %>)
          </div>
        </div>
        <% } %>
      </div>

      <hr class="my-4" />

      <!-- What's Next -->
      <h6 class="mb-3">What happens next?</h6>
      <div class="timeline">
        <div class="timeline-item active">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <small class="text-muted">Order Placed</small>
            <p class="mb-0 small">We've received your order</p>
          </div>
        </div>
        <div class="timeline-item">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <small class="text-muted">Order Processing</small>
            <p class="mb-0 small">We're preparing your items</p>
          </div>
        </div>
        <div class="timeline-item">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <small class="text-muted">Shipped</small>
            <p class="mb-0 small">Your order is on the way</p>
          </div>
        </div>
        <div class="timeline-item">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <small class="text-muted">Delivered</small>
            <p class="mb-0 small">Your order has arrived</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Email -->
  <div class="alert alert-info mt-4 mx-auto" style="max-width: 500px">
    <i class="bi bi-envelope me-2"></i>
    A confirmation email has been sent to
    <strong><%= order.customerEmail %></strong>
  </div>

  <!-- Action Buttons -->
  <div class="mt-5">
    <a href="/products" class="btn btn-primary btn-lg me-3">
      <i class="bi bi-bag me-2"></i>
      Continue Shopping
    </a>

    <a href="/order/my-orders" class="btn btn-outline-secondary btn-lg">
      <i class="bi bi-list-ul me-2"></i>
      View Order History
    </a>

    <% if (successData) { %>
    <div class="mt-4">
      <a
        href="javascript:void(0)"
        onclick="printOrder()"
        class="btn btn-outline-dark"
      >
        <i class="bi bi-printer me-2"></i>
        Print Order Details
      </a>
    </div>
    <% } %>
  </div>

  <!-- Support Information -->
  <div class="mt-5 pt-4 border-top">
    <h6 class="mb-3">Need Help?</h6>
    <p class="text-muted mb-2">
      Contact our customer support for any questions about your order.
    </p>
    <div class="row justify-content-center">
      <div class="col-auto">
        <a href="mailto:support@myshop.com" class="text-decoration-none">
          <i class="bi bi-envelope me-1"></i>
          support@myshop.com
        </a>
      </div>
      <div class="col-auto">
        <span class="text-muted">•</span>
      </div>
      <div class="col-auto">
        <a href="tel:+15551234567" class="text-decoration-none">
          <i class="bi bi-telephone me-1"></i>
          +1 (555) 123-4567
        </a>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<!-- Order Success Page Styles & Scripts -->
<style>
  .success-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 120px;
    height: 120px;
    background-color: #d4edda;
    border-radius: 50%;
    margin: 0 auto;
  }
  .success-icon i {
    font-size: 4rem;
    color: #28a745;
  }
  .timeline {
    position: relative;
    padding-left: 30px;
  }
  .timeline-item {
    position: relative;
    padding-bottom: 20px;
  }
  .timeline-item:last-child {
    padding-bottom: 0;
  }
  .timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: #dee2e6;
    border: 3px solid white;
  }
  .timeline-item.active .timeline-marker {
    background-color: #28a745;
  }
  .timeline-content {
    padding-left: 10px;
  }
</style>

<script>
  // Print order details
  function printOrder() {
    const printContent = `
        <html>
        <head>
            <title>Order Confirmation - <%= order.orderId %></title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .header h1 { color: #28a745; }
                .details { margin-bottom: 20px; }
                .details table { width: 100%; border-collapse: collapse; }
                .details th, .details td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                .items { margin-bottom: 20px; }
                .items table { width: 100%; border-collapse: collapse; }
                .items th { background-color: #f8f9fa; }
                .footer { margin-top: 30px; font-size: 12px; color: #666; text-align: center; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Order Confirmation</h1>
                <p>Thank you for your order!</p>
            </div>
            
            <div class="details">
                <table>
                    <tr><th>Order ID:</th><td><%= order.orderId %></td></tr>
                    <tr><th>Date:</th><td><%= new Date(order.createdAt).toLocaleString() %></td></tr>
                    <tr><th>Email:</th><td><%= order.customerEmail %></td></tr>
                    <tr><th>Status:</th><td><%= order.status %></td></tr>
                    <tr><th>Total:</th><td>$<%= order.total.toFixed(2) %></td></tr>
                </table>
            </div>
            
            <div class="items">
                <h3>Order Items</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% order.items.forEach(item => { %>
                        <tr>
                            <td><%= item.name %></td>
                            <td><%= item.quantity %></td>
                            <td>$<%= item.price.toFixed(2) %></td>
                            <td>$<%= item.subtotal.toFixed(2) %></td>
                        </tr>
                        <% }) %>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right; font-weight: bold;">Grand Total:</td>
                            <td style="font-weight: bold;">$<%= order.total.toFixed(2) %></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="footer">
                <p>Thank you for shopping with us!</p>
                <p>MyShop • support@myshop.com • +1 (555) 123-4567</p>
            </div>
        </body>
        </html>
    `;

    const printWindow = window.open("", "_blank");
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 250);
  }

  // Redirect after 30 seconds of inactivity
  let idleTime = 0;
  const idleInterval = setInterval(() => {
    idleTime++;
    if (idleTime > 180) {
      // 3 minutes
      clearInterval(idleInterval);
      window.location.href = "/products";
    }
  }, 1000);

  // Reset idle time on user activity
  document.addEventListener("mousemove", () => (idleTime = 0));
  document.addEventListener("keypress", () => (idleTime = 0));
  document.addEventListener("click", () => (idleTime = 0));

  // Confetti effect (optional)
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof successData !== "undefined" && successData.orderId) {
      // Simple confetti effect
      setTimeout(() => {
        const confettiCount = 50;
        const colors = ["#28a745", "#17a2b8", "#ffc107", "#dc3545"];

        for (let i = 0; i < confettiCount; i++) {
          const confetti = document.createElement("div");
          confetti.style.position = "fixed";
          confetti.style.width = "10px";
          confetti.style.height = "10px";
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          confetti.style.borderRadius = "50%";
          confetti.style.top = "-20px";
          confetti.style.left = Math.random() * 100 + "vw";
          confetti.style.zIndex = "9999";
          confetti.style.pointerEvents = "none";
          document.body.appendChild(confetti);

          // Animation
          const animation = confetti.animate(
            [
              { transform: "translateY(0) rotate(0deg)", opacity: 1 },
              {
                transform: `translateY(${window.innerHeight + 20}px) rotate(${
                  Math.random() * 360
                }deg)`,
                opacity: 0,
              },
            ],
            {
              duration: 1000 + Math.random() * 2000,
              easing: "cubic-bezier(0.215, 0.610, 0.355, 1)",
            }
          );

          animation.onfinish = () => confetti.remove();
        }
      }, 500);
    }
  });
</script>
