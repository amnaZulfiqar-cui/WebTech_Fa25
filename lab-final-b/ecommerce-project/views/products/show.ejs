<%- include('../partials/header') %>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item"><a href="/products">Products</a></li>
    <li class="breadcrumb-item">
      <a href="/products?category=<%= product.category %>"
        ><%= product.category %></a
      >
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      <%= product.name %>
    </li>
  </ol>
</nav>

<div class="row">
  <!-- Product Images -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <!-- Main Image -->
        <div class="text-center mb-3">
          <img
            src="<%= product.image %>"
            alt="<%= product.name %>"
            class="img-fluid rounded"
            id="mainImage"
            style="max-height: 400px; object-fit: contain"
          />
        </div>

        <!-- Image Gallery (placeholder) -->
        <div class="row g-2">
          <div class="col-3">
            <a href="#" class="thumbnail-link">
              <img
                src="<%= product.image %>"
                alt="<%= product.name %>"
                class="img-thumbnail active"
              />
            </a>
          </div>
          <div class="col-3">
            <a href="#" class="thumbnail-link">
              <img
                src="<%= product.image %>"
                alt="<%= product.name %> - 2"
                class="img-thumbnail"
              />
            </a>
          </div>
          <div class="col-3">
            <a href="#" class="thumbnail-link">
              <img
                src="<%= product.image %>"
                alt="<%= product.name %> - 3"
                class="img-thumbnail"
              />
            </a>
          </div>
          <div class="col-3">
            <a href="#" class="thumbnail-link">
              <img
                src="<%= product.image %>"
                alt="<%= product.name %> - 4"
                class="img-thumbnail"
              />
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Details -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <!-- Badges -->
        <div class="mb-3">
          <% if (product.featured) { %>
          <span class="badge bg-warning me-2">
            <i class="bi bi-star-fill me-1"></i>Featured
          </span>
          <% } %>
          <span class="badge bg-info">
            <i class="bi bi-tag me-1"></i><%= product.category %>
          </span>
        </div>

        <!-- Product Name -->
        <h1 class="h2 fw-bold mb-3"><%= product.name %></h1>

        <!-- Price -->
        <div class="mb-4">
          <span class="h3 text-primary fw-bold"
            >$<%= product.price.toFixed(2) %></span
          >
          <small class="text-muted ms-2">(Inclusive of all taxes)</small>
        </div>

        <!-- Stock Status -->
        <div class="mb-4">
          <% if (product.stock > 0) { %> <% if (product.stock < 10) { %>
          <span class="badge bg-warning">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Only <%= product.stock %> left in stock
          </span>
          <% } else { %>
          <span class="badge bg-success">
            <i class="bi bi-check-circle me-1"></i>
            In Stock (<%= product.stock %> available)
          </span>
          <% } %> <% } else { %>
          <span class="badge bg-danger">
            <i class="bi bi-x-circle me-1"></i>
            Out of Stock
          </span>
          <% } %>
        </div>

        <!-- Description -->
        <div class="mb-4">
          <h5 class="mb-2">Description</h5>
          <p class="text-muted"><%= product.description %></p>
        </div>

        <!-- Add to Cart Form -->
        <% if (product.stock > 0) { %>
        <form action="/cart/add/<%= product._id %>" method="POST" class="mb-4">
          <div class="row g-3 align-items-center">
            <div class="col-auto">
              <label for="quantity" class="col-form-label fw-bold"
                >Quantity:</label
              >
            </div>
            <div class="col-auto">
              <div class="input-group" style="width: 150px">
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="decreaseQty"
                >
                  -
                </button>
                <input
                  type="number"
                  class="form-control text-center"
                  id="quantity"
                  name="quantity"
                  value="1"
                  min="1"
                  max="<%= product.stock %>"
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="increaseQty"
                >
                  +
                </button>
              </div>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary btn-lg px-4">
                <i class="bi bi-cart-plus me-2"></i>
                Add to Cart
              </button>
            </div>
          </div>
        </form>
        <% } else { %>
        <div class="alert alert-warning mb-4">
          <i class="bi bi-exclamation-triangle me-2"></i>
          This product is currently out of stock. Check back later!
        </div>
        <% } %>

        <!-- Additional Info -->
        <div class="border-top pt-4">
          <h5 class="mb-3">Product Information</h5>
          <table class="table table-sm">
            <tr>
              <th style="width: 40%">Category:</th>
              <td><%= product.category %></td>
            </tr>
            <tr>
              <th>SKU:</th>
              <td>
                PROD-<%= product._id.toString().substring(0, 8).toUpperCase() %>
              </td>
            </tr>
            <tr>
              <th>Added on:</th>
              <td><%= new Date(product.createdAt).toLocaleDateString() %></td>
            </tr>
            <% if (product.updatedAt && product.updatedAt !== product.createdAt)
            { %>
            <tr>
              <th>Last updated:</th>
              <td><%= new Date(product.updatedAt).toLocaleDateString() %></td>
            </tr>
            <% } %>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reviews Section -->
<div class="mt-5">
  <div class="card shadow-sm">
    <div class="card-body p-4">
      <h4 class="mb-4">Customer Reviews</h4>

      <!-- Review Summary -->
      <div class="row mb-4">
        <div class="col-md-4 text-center">
          <div class="display-4 fw-bold text-primary">4.5</div>
          <div class="mb-2">
            <% for (let i = 1; i <= 5; i++) { %>
            <i class="bi bi-star-fill text-warning"></i>
            <% } %>
          </div>
          <small class="text-muted">Based on 24 reviews</small>
        </div>
        <div class="col-md-8">
          <!-- Rating breakdown would go here -->
          <p class="text-muted">
            No reviews yet. Be the first to review this product!
          </p>
        </div>
      </div>

      <!-- Add Review Form -->
      <div class="mb-4">
        <button
          class="btn btn-outline-primary"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#reviewForm"
        >
          <i class="bi bi-pencil me-2"></i>Write a Review
        </button>

        <div class="collapse mt-3" id="reviewForm">
          <form action="/products/<%= product._id %>/review" method="POST">
            <div class="mb-3">
              <label class="form-label">Your Rating</label>
              <div class="rating">
                <% for (let i = 5; i >= 1; i--) { %>
                <input
                  type="radio"
                  id="star<%= i %>"
                  name="rating"
                  value="<%= i %>"
                />
                <label for="star<%= i %>" title="<%= i %> stars">â˜…</label>
                <% } %>
              </div>
            </div>
            <div class="mb-3">
              <label for="name" class="form-label">Your Name</label>
              <input type="text" class="form-control" id="name" name="name" />
            </div>
            <div class="mb-3">
              <label for="comment" class="form-label">Your Review</label>
              <textarea
                class="form-control"
                id="comment"
                name="comment"
                rows="3"
              ></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Review</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Related Products -->
<% if (relatedProducts && relatedProducts.length > 0) { %>
<div class="mt-5">
  <h4 class="mb-4">Related Products</h4>
  <div class="row">
    <% relatedProducts.forEach(product => { %>
    <div class="col-md-3 col-6 mb-4">
      <div class="card h-100">
        <img
          src="<%= product.image %>"
          class="card-img-top"
          alt="<%= product.name %>"
          style="height: 150px; object-fit: cover"
        />
        <div class="card-body">
          <h6 class="card-title"><%= product.name %></h6>
          <p class="card-text text-primary fw-bold mb-2">
            $<%= product.price.toFixed(2) %>
          </p>
          <a
            href="/products/<%= product._id %>"
            class="btn btn-sm btn-outline-primary w-100"
          >
            View Details
          </a>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
</div>
<% } %> <%- include('../partials/footer') %>

<!-- Product Show Page Styles & Scripts -->
<style>
  .thumbnail-link .img-thumbnail {
    border: 2px solid transparent;
    transition: all 0.3s;
    cursor: pointer;
  }
  .thumbnail-link .img-thumbnail:hover,
  .thumbnail-link .img-thumbnail.active {
    border-color: var(--bs-primary);
  }
  .rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
  }
  .rating input {
    display: none;
  }
  .rating label {
    cursor: pointer;
    font-size: 2rem;
    color: #ddd;
    transition: color 0.3s;
  }
  .rating input:checked ~ label,
  .rating label:hover,
  .rating label:hover ~ label {
    color: #ffc107;
  }
</style>

<script>
  // Quantity controls
  document.getElementById("decreaseQty").addEventListener("click", function () {
    const input = document.getElementById("quantity");
    if (parseInt(input.value) > 1) {
      input.value = parseInt(input.value) - 1;
    }
  });

  document.getElementById("increaseQty").addEventListener("click", function () {
    const input = document.getElementById("quantity");
    const max = parseInt(input.max);
    if (parseInt(input.value) < max) {
      input.value = parseInt(input.value) + 1;
    }
  });

  // Image gallery
  document.querySelectorAll(".thumbnail-link").forEach((link) => {
    link.addEventListener("click", function (e) {
      e.preventDefault();

      // Update active thumbnail
      document.querySelectorAll(".img-thumbnail").forEach((thumb) => {
        thumb.classList.remove("active");
      });
      this.querySelector(".img-thumbnail").classList.add("active");

      // Update main image
      const newSrc = this.querySelector("img").src;
      document.getElementById("mainImage").src = newSrc;
    });
  });

  // Quantity validation
  document.getElementById("quantity").addEventListener("change", function () {
    const max = parseInt(this.max);
    const min = parseInt(this.min);
    let value = parseInt(this.value);

    if (value < min) this.value = min;
    if (value > max) this.value = max;
    if (isNaN(value)) this.value = min;
  });
</script>
