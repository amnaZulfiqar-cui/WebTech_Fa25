<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRUD App with jQuery and JSONPlaceholder</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Posts CRUD App</h1>

      <!-- Loading Spinner (hidden initially) -->
      <div id="loading" class="text-center" style="display: none">
        <div class="spinner-border" role="status"></div>
        <p>Loading...</p>
      </div>

      <!-- Table for displaying posts (Read) -->
      <table id="postsTable" class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Body</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Form for Create/Update -->
      <h2 class="mt-4">Add/Edit Post</h2>
      <form id="postForm">
        <input type="hidden" id="postId" value="" />
        <div class="mb-3">
          <label for="title" class="form-label">Title</label>
          <input type="text" class="form-control" id="title" required />
        </div>
        <div class="mb-3">
          <label for="body" class="form-label">Body</label>
          <textarea class="form-control" id="body" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Save Post</button>
      </form>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "https://jsonplaceholder.typicode.com/posts";

      $(document).ready(function () {
        loadPosts(); // Fetch posts when page loads

        // Edit button click handler
        $("#postsTable").on("click", ".edit-btn", function () {
          const id = $(this).data("id");
          $("#loading").show();
          $.ajax({
            url: `${API_URL}/${id}`,
            method: "GET",
            success: function (post) {
              $("#postId").val(post.id);
              $("#title").val(post.title);
              $("#body").val(post.body);
              $("#loading").hide();
            },
            error: function () {
              alert("Error fetching post for edit.");
              $("#loading").hide();
            },
          });
        });

        // Delete button click handler
        $("#postsTable").on("click", ".delete-btn", function () {
          const id = $(this).data("id");
          if (confirm("Are you sure you want to delete this post?")) {
            $("#loading").show();
            $.ajax({
              url: `${API_URL}/${id}`,
              method: "DELETE",
              success: function () {
                $(`#post-${id}`).remove();
                $("#loading").hide();
                alert("Post deleted successfully!");
              },
              error: function () {
                alert("Error deleting post.");
                $("#loading").hide();
              },
            });
          }
        });

        // Form submission handler
        $("#postForm").submit(function (e) {
          e.preventDefault(); // Prevent page reload
          const id = $("#postId").val();
          const title = $("#title").val();
          const body = $("#body").val();

          if (!title || !body) {
            alert("Please fill in all fields.");
            return;
          }

          const postData = { title, body, userId: 1 }; // userId required for JSONPlaceholder

          if (id) {
            // Update
            $("#loading").show();
            $.ajax({
              url: `${API_URL}/${id}`,
              method: "PUT",
              data: JSON.stringify(postData),
              contentType: "application/json",
              success: function (updatedPost) {
                $(`#post-${id} td:nth-child(2)`).text(updatedPost.title);
                $(`#post-${id} td:nth-child(3)`).text(updatedPost.body);
                resetForm();
                $("#loading").hide();
                alert("Post updated successfully!");
              },
              error: function () {
                alert("Error updating post.");
                $("#loading").hide();
              },
            });
          } else {
            // Create
            $("#loading").show();
            $.ajax({
              url: API_URL,
              method: "POST",
              data: JSON.stringify(postData),
              contentType: "application/json",
              success: function (newPost) {
                newPost.id = 101 + Math.floor(Math.random() * 100); // Fake ID since API returns 101
                appendPostToTable(newPost);
                resetForm();
                $("#loading").hide();
                alert("Post created successfully!");
              },
              error: function () {
                alert("Error creating post.");
                $("#loading").hide();
              },
            });
          }
        });
      });

      function loadPosts() {
        $("#loading").show(); // Show spinner
        $.ajax({
          url: API_URL,
          method: "GET",
          success: function (posts) {
            $("#postsTable tbody").empty(); // Clear table
            posts.slice(0, 10).forEach((post) => {
              // Limit to 10 for simplicity
              appendPostToTable(post);
            });
            $("#loading").hide();
          },
          error: function () {
            alert("Error fetching posts. Please try again.");
            $("#loading").hide();
          },
        });
      }

      function appendPostToTable(post) {
        $("#postsTable tbody").append(`
                <tr id="post-${post.id}">
                    <td>${post.id}</td>
                    <td>${post.title}</td>
                    <td>${post.body}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn" data-id="${post.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${post.id}">Delete</button>
                    </td>
                </tr>
            `);
      }

      function resetForm() {
        $("#postId").val("");
        $("#title").val("");
        $("#body").val("");
      }
    </script>
  </body>
</html>
